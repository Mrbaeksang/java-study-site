<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âš¡ íŠ¸ëœì­ì…˜ê³¼ ì„±ëŠ¥ ìµœì í™”</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ì´ì „ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .section {
      background: var(--vscode-darker);
      border: 1px solid var(--vscode-highlight);
      border-radius: 8px;
      margin: 2rem auto;
      padding: 2rem;
      max-width: 1000px;
    }
    /* ... (ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ë„ ì´ì „ê³¼ ë™ì¼) ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âš¡ íŠ¸ëœì­ì…˜ê³¼ ì„±ëŠ¥ ìµœì í™”</h1>
      <p class="intro-text">ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê³  JPA ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.</p>
    </header>

    <main>
      <div class="section">
        <h2>7. íŠ¸ëœì­ì…˜ ê´€ë¦¬</h2>
        
        <div class="step">
          <h3><span class="step-number">1</span> ì„ ì–¸ì  íŠ¸ëœì­ì…˜</h3>
          <p>ìŠ¤í”„ë§ì˜ <code>@Transactional</code> ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ì„ ì„ ì–¸ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          
          <pre class="code-block"><code class="language-java">package com.example.demo.service;

import com.example.demo.dto.TransferRequest;
import com.example.demo.entity.Account;
import com.example.demo.exception.InsufficientBalanceException;
import com.example.demo.repository.AccountRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;

@Service
@RequiredArgsConstructor
public class BankService {
    
    private final AccountRepository accountRepository;
    
    // ê¸°ë³¸ íŠ¸ëœì­ì…˜ ì„¤ì •
    @Transactional
    public void transferMoney(TransferRequest request) {
        Account fromAccount = accountRepository.findById(request.getFromAccountId())
                .orElseThrow(() -> new IllegalArgumentException("ì¶œê¸ˆ ê³„ì¢Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                
        Account toAccount = accountRepository.findById(request.getToAccountId())
                .orElseThrow(() -> new IllegalArgumentException("ì…ê¸ˆ ê³„ì¢Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        
        // ì”ì•¡ í™•ì¸
        if (fromAccount.getBalance().compareTo(request.getAmount()) < 0) {
            throw new InsufficientBalanceException("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
        
        // ê³„ì¢Œ ì´ì²´
        fromAccount.withdraw(request.getAmount());
        toAccount.deposit(request.getAmount());
        
        // ê³„ì¢Œ ì •ë³´ ì €ì¥ (ë³€ê²½ ê°ì§€ - Dirty Checking)
        accountRepository.save(fromAccount);
        accountRepository.save(toAccount);
        
        // ì´ì²´ ë‚´ì—­ ê¸°ë¡ (íŠ¸ëœì­ì…˜ ì „íŒŒ ì˜ˆì‹œ)
        transactionHistoryService.recordTransfer(
            request.getFromAccountId(),
            request.getToAccountId(),
            request.getAmount(),
            "ê³„ì¢Œ ì´ì²´"
        );
    }
    
    // ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ (ì„±ëŠ¥ ìµœì í™”)
    @Transactional(readOnly = true)
    public Account getAccountWithTransactions(Long accountId) {
        return accountRepository.findWithTransactionsById(accountId)
                .orElseThrow(() -> new IllegalArgumentException("ê³„ì¢Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }
    
    // íŠ¸ëœì­ì…˜ ì „íŒŒ ì„¤ì • ì˜ˆì‹œ
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void processInNewTransaction() {
        // ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰
    }
    
    // íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ì„¤ì • ì˜ˆì‹œ
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public void processWithHighIsolation() {
        // ì§ë ¬í™” ê°€ëŠ¥í•œ ê²©ë¦¬ ìˆ˜ì¤€ìœ¼ë¡œ ì‹¤í–‰
    }
    
    // íŠ¸ëœì­ì…˜ ë¡¤ë°± ì„¤ì • ì˜ˆì‹œ
    @Transactional(rollbackFor = {BusinessException.class})
    public void processWithCustomRollback() {
        // BusinessException ë°œìƒ ì‹œ ë¡¤ë°±
    }
    
    // íŠ¸ëœì­ì…˜ ì‹œê°„ ì´ˆê³¼ ì„¤ì • ì˜ˆì‹œ
    @Transactional(timeout = 30) // 30ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
    public void processWithTimeout() {
        // ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…
    }
}

// ê³„ì¢Œ ì—”í‹°í‹° ì˜ˆì‹œ
@Entity
@Table(name = "accounts")
@Getter @Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Account extends BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true, length = 20)
    private String accountNumber;
    
    @Column(nullable = false, precision = 15, scale = 2)
    private BigDecimal balance = BigDecimal.ZERO;
    
    @OneToMany(mappedBy = "account", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Transaction> transactions = new ArrayList<>();
    
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ
    public void deposit(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("ì…ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
        }
        this.balance = this.balance.add(amount);
    }
    
    public void withdraw(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("ì¶œê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (this.balance.compareTo(amount) < 0) {
            throw new InsufficientBalanceException("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
        this.balance = this.balance.subtract(amount);
    }
    
    // ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ
    public void addTransaction(Transaction transaction) {
        transactions.add(transaction);
        transaction.setAccount(this);
    }
}</code></pre>
          
          <div class="note">
            <h4>ğŸ“Œ íŠ¸ëœì­ì…˜ ì „íŒŒ(Propagation) ì†ì„±</h4>
            <ul>
              <li><code>REQUIRED</code>: ê¸°ë³¸ê°’, ì´ë¯¸ ì‹œì‘ëœ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì°¸ì—¬í•˜ê³  ì—†ìœ¼ë©´ ìƒˆë¡œ ì‹œì‘</li>
              <li><code>REQUIRES_NEW</code>: í•­ìƒ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘, ê¸°ì¡´ íŠ¸ëœì­ì…˜ì€ ì¼ì‹œ ì¤‘ì§€</li>
              <li><code>SUPPORTS</code>: ì´ë¯¸ ì‹œì‘ëœ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì°¸ì—¬í•˜ê³  ì—†ìœ¼ë©´ íŠ¸ëœì­ì…˜ ì—†ì´ ì‹¤í–‰</li>
              <li><code>NOT_SUPPORTED</code>: íŠ¸ëœì­ì…˜ ì—†ì´ ì‹¤í–‰, ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì¼ì‹œ ì¤‘ì§€</li>
              <li><code>MANDATORY</code>: ë°˜ë“œì‹œ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰, ì—†ìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ</li>
              <li><code>NEVER</code>: íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰ë˜ë©´ ì˜ˆì™¸ ë°œìƒ</li>
              <li><code>NESTED</code>: ì¤‘ì²© íŠ¸ëœì­ì…˜ ìƒì„± (ë¶€ëª¨ íŠ¸ëœì­ì…˜ì— ì¤‘ì²©)</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>8. JPA ì„±ëŠ¥ ìµœì í™”</h2>
        
        <div class="step">
          <h3><span class="step-number">1</span> N+1 ë¬¸ì œ í•´ê²°</h3>
          <p>N+1 ë¬¸ì œëŠ” ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ì´ìŠˆì…ë‹ˆë‹¤.</p>
          
          <pre class="code-block"><code class="language-java">// N+1 ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì˜ˆì œ
@Transactional(readOnly = true)
public List<Order> getOrdersWithItems() {
    // 1. ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ (1ë²ˆì˜ ì¿¼ë¦¬)
    List<Order> orders = orderRepository.findAll();
    
    // 2. ê° ì£¼ë¬¸ì˜ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (Në²ˆì˜ ì¶”ê°€ ì¿¼ë¦¬)
    for (Order order : orders) {
        List<OrderItem> items = order.getItems(); // ì—¬ê¸°ì„œ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ
        // ...
    }
    
    return orders;
}

// í•´ê²° ë°©ë²• 1: í˜ì¹˜ ì¡°ì¸ ì‚¬ìš©
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @Query("SELECT DISTINCT o FROM Order o JOIN FETCH o.items i")
    List<Order> findAllWithItems();
    
    // í˜ì´ì§•ê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
    @Query(value = "SELECT o FROM Order o JOIN FETCH o.items i",
           countQuery = "SELECT COUNT(o) FROM Order o")
    Page<Order> findAllWithItems(Pageable pageable);
}

// í•´ê²° ë°©ë²• 2: @EntityGraph ì‚¬ìš©
@EntityGraph(attributePaths = {"items"})
List<Order> findByStatus(OrderStatus status);

// í•´ê²° ë°©ë²• 3: ë°°ì¹˜ í˜ì¹˜ í¬ê¸° ì„¤ì • (in ì ˆë¡œ ì¡°íšŒ)
@Entity
@Table(name = "orders")
@Getter @Setter
@BatchSize(size = 100) // ë°°ì¹˜ í˜ì¹˜ í¬ê¸° ì„¤ì •
public class Order {
    @OneToMany(mappedBy = "order", fetch = FetchType.LAZY)
    private List<OrderItem> items = new ArrayList<>();
}

// application.propertiesì— ì „ì—­ ì„¤ì •
spring.jpa.properties.hibernate.default_batch_fetch_size=100</code></pre>
        </div>

        <div class="step">
          <h3><span class="step-number">2</span> ì„±ëŠ¥ ìµœì í™” íŒ</h3>
          
          <pre class="code-block"><code class="language-java">// 1. ì½ê¸° ì „ìš© ì¿¼ë¦¬ ìµœì í™”
@Transactional(readOnly = true) // ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜
public List<Order> findRecentOrders(LocalDateTime from) {
    return orderRepository.findByCreatedAtAfter(from);
}

// 2. DTO í”„ë¡œì ì…˜ ì‚¬ìš© (ì—”í‹°í‹° ëŒ€ì‹  í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ)
public interface OrderSummary {
    Long getId();
    String getOrderNumber();
    BigDecimal getTotalAmount();
    
    // @Valueë¥¼ ì‚¬ìš©í•œ ì»¤ìŠ¤í…€ ìƒì„±ì
    @Value("#{target.orderNumber + ' - ' + target.totalAmount}")
    String getSummary();
}

@Query("SELECT o.id as id, o.orderNumber as orderNumber, o.totalAmount as totalAmount " +
       "FROM Order o WHERE o.status = :status")
List<OrderSummary> findOrderSummariesByStatus(OrderStatus status);

// 3. ë²Œí¬ ì—°ì‚° ì‚¬ìš©
@Modifying
@Query("UPDATE Product p SET p.price = p.price * :rate WHERE p.category = :category")
int updatePriceByCategory(@Param("category") String category, @Param("rate") double rate);

// 4. ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš©
@QueryHints({
    @QueryHint(name = "org.hibernate.readOnly", value = "true"),
    @QueryHint(name = "javax.persistence.query.timeout", value = "5000")
})
@Query("SELECT o FROM Order o WHERE o.status = :status")
List<Order> findOrdersByStatusWithHints(@Param("status") OrderStatus status);

// 5. ë‘ ë²ˆì§¸ ë ˆë²¨ ìºì‹œ í™œì„±í™”
// application.properties
spring.jpa.properties.hibernate.cache.use_second_level_cache=true
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.jcache.JCacheRegionFactory
spring.jpa.properties.javax.persistence.sharedCache.mode=ENABLE_SELECTIVE

// ì—”í‹°í‹°ì— ìºì‹œ ì„¤ì •
@Entity
@Table(name = "products")
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Product {
    // ...
}

// ë¦¬í¬ì§€í† ë¦¬ ë©”ì„œë“œì— ìºì‹œ ì ìš©
@Cacheable("products")
Optional<Product> findById(Long id);

@CacheEvict(value = "products", key = "#product.id")
Product save(Product product);</code></pre>
        </div>
      </div>

      <div class="section">
        <h2>9. í…ŒìŠ¤íŠ¸</h2>
        
        <div class="step">
          <h3><span class="step-number">1</span> ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ í…ŒìŠ¤íŠ¸</h3>
          
          <pre class="code-block"><code class="language-java">@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@ActiveProfiles("test")
class UserRepositoryTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private TestEntityManager em;
    
    @Test
    @Sql("/test-data.sql") // í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
    void whenFindByEmail_thenReturnUser() {
        // given
        String email = "test@example.com";
        
        // when
        Optional<User> foundUser = userRepository.findByEmail(email);
        
        // then
        assertThat(foundUser).isPresent();
        assertThat(foundUser.get().getEmail()).isEqualTo(email);
    }
    
    @Test
    void whenSaveUser_thenCanFindById() {
        // given
        User user = User.builder()
                .username("testuser")
                .email("test@example.com")
                .password("encodedPassword")
                .build();
        
        // when
        User savedUser = userRepository.save(user);
        em.flush();
        em.clear(); // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        
        // then
        User foundUser = userRepository.findById(savedUser.getId())
                .orElseThrow(() -> new AssertionError("User not found"));
                
        assertThat(foundUser.getUsername()).isEqualTo(user.getUsername());
    }
    
    @Test
    @Transactional
    void whenUpdateUser_thenUpdated() {
        // given
        User user = User.builder()
                .username("oldname")
                .email("test@example.com")
                .password("password")
                .build();
        em.persistAndFlush(user);
        
        // when
        user.updateUsername("newname");
        em.flush();
        em.clear();
        
        // then
        User updatedUser = userRepository.findById(user.getId())
                .orElseThrow(() -> new AssertionError("User not found"));
                
        assertThat(updatedUser.getUsername()).isEqualTo("newname");
    }
}

// í…ŒìŠ¤íŠ¸ìš© SQL (src/test/resources/test-data.sql)
INSERT INTO users (id, username, email, password, created_at, updated_at) 
VALUES (1, 'testuser', 'test@example.com', 'encodedPassword', NOW(), NOW());</code></pre>
        </div>

        <div class="step">
          <h3><span class="step-number">2</span> ì„œë¹„ìŠ¤ ê³„ì¸µ í…ŒìŠ¤íŠ¸</h3>
          
          <pre class="code-block"><code class="language-java">@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void whenRegisterUser_thenUserIsSaved() {
        // given
        String email = "test@example.com";
        String password = "password";
        String encodedPassword = "encodedPassword";
        
        UserDto.CreateRequest request = new UserDto.CreateRequest();
        request.setEmail(email);
        request.setPassword(password);
        
        when(passwordEncoder.encode(password)).thenReturn(encodedPassword);
        when(userRepository.existsByEmail(email)).thenReturn(false);
        when(userRepository.save(any(User.class))).thenAnswer(invocation -> {
            User user = invocation.getArgument(0);
            user.setId(1L);
            return user;
        });
        
        // when
        Long userId = userService.registerUser(request);
        
        // then
        assertThat(userId).isNotNull();
        verify(userRepository, times(1)).save(any(User.class));
        verify(passwordEncoder, times(1)).encode(password);
    }
    
    @Test
    void whenRegisterWithExistingEmail_thenThrowException() {
        // given
        String email = "existing@example.com";
        
        UserDto.CreateRequest request = new UserDto.CreateRequest();
        request.setEmail(email);
        request.setPassword("password");
        
        when(userRepository.existsByEmail(email)).thenReturn(true);
        
        // when & then
        assertThatThrownBy(() -> userService.registerUser(request))
                .isInstanceOf(DuplicateEmailException.class)
                .hasMessage("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
                
        verify(userRepository, never()).save(any(User.class));
    }
}

// í†µí•© í…ŒìŠ¤íŠ¸ ì˜ˆì œ
@SpringBootTest
@Transactional
@ActiveProfiles("test")
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Test
    void whenRegisterUser_thenCanFindByEmail() {
        // given
        UserDto.CreateRequest request = new UserDto.CreateRequest();
        request.setEmail("test@example.com");
        request.setPassword("password");
        
        // when
        Long userId = userService.registerUser(request);
        
        // then
        User foundUser = userRepository.findByEmail("test@example.com")
                .orElseThrow(() -> new AssertionError("User not found"));
                
        assertThat(foundUser.getId()).isEqualTo(userId);
        assertThat(passwordEncoder.matches("password", foundUser.getPassword())).isTrue();
    }
}</code></pre>
        </div>
      </div>

      <div class="nav-buttons">
        <a href="spring_boot_database_part4.html" class="nav-button">â† ì´ì „: Spring Data JPA ë¦¬í¬ì§€í† ë¦¬</a>
        <a href="spring_boot_security.html" class="nav-button">ë‹¤ìŒ: ìŠ¤í”„ë§ ì‹œíë¦¬í‹° â†’</a>
      </div>
    </main>
  </div>
</body>
</html>
