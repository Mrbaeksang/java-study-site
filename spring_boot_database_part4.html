<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“š Spring Data JPA ë¦¬í¬ì§€í† ë¦¬</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ì´ì „ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .section {
      background: var(--vscode-darker);
      border: 1px solid var(--vscode-highlight);
      border-radius: 8px;
      margin: 2rem auto;
      padding: 2rem;
      max-width: 1000px;
    }
    /* ... (ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ë„ ì´ì „ê³¼ ë™ì¼) ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“š Spring Data JPA ë¦¬í¬ì§€í† ë¦¬</h1>
      <p class="intro-text">Spring Data JPAë¥¼ í™œìš©í•œ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ êµ¬í˜„ ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.</p>
    </header>

    <main>
      <div class="section">
        <h2>5. Spring Data JPA ë¦¬í¬ì§€í† ë¦¬</h2>
        
        <div class="step">
          <h3><span class="step-number">1</span> ê¸°ë³¸ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤</h3>
          <p>Spring Data JPAëŠ” ì¸í„°í˜ì´ìŠ¤ë§Œìœ¼ë¡œë„ ê¸°ë³¸ì ì¸ CRUD ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
          
          <pre class="code-block"><code class="language-java">package com.example.demo.repository;

import com.example.demo.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ
    Optional<User> findByEmail(String email);
    
    // ì‚¬ìš©ìëª…ìœ¼ë¡œ ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    boolean existsByUsername(String username);
    
    // í™œì„± ìƒíƒœì¸ ì‚¬ìš©ì ìˆ˜ ì¡°íšŒ
    long countByStatus(User.UserStatus status);
    
    // ì„±ìœ¼ë¡œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬)
    List<User> findByLastNameOrderByFirstNameAsc(String lastName);
    
    // ì´ë©”ì¼ ë„ë©”ì¸ìœ¼ë¡œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (í˜ì´ì§• ì²˜ë¦¬)
    Page<User> findByEmailEndingWith(String emailDomain, Pageable pageable);
    
    // ìƒì„±ì¼ì‹œ ì´í›„ì˜ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
    List<User> findByCreatedAtAfter(LocalDateTime dateTime);
    
    // ì‚¬ìš©ìëª… ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰
    List<User> findByUsernameContainingOrEmailContaining(String username, String email);
    
    // ìƒíƒœê°€ ì£¼ì–´ì§„ ëª©ë¡ì— ìˆëŠ” ì‚¬ìš©ì ì¡°íšŒ
    List<User> findByStatusIn(List<User.UserStatus> statuses);
    
    // ì‚¬ìš©ìëª…ì´ íŠ¹ì • íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ëŠ” ì‚¬ìš©ì ì¡°íšŒ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
    List<User> findByUsernameLikeIgnoreCase(String pattern);
    
    // ìƒì„±ì¼ì‹œê°€ íŠ¹ì • ê¸°ê°„ ë‚´ì¸ ì‚¬ìš©ì ì¡°íšŒ
    List<User> findByCreatedAtBetween(LocalDateTime start, LocalDateTime end);
    
    // ê²Œì‹œê¸€ì´ nê°œ ì´ìƒì¸ ì‚¬ìš©ì ì¡°íšŒ
    @Query("SELECT u FROM User u WHERE SIZE(u.posts) >= :minPosts")
    List<User> findByMinPosts(@Param("minPosts") int minPosts);
    
    // ì‚¬ìš©ìì™€ ì—°ê´€ëœ ê²Œì‹œê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
    @Modifying
    @Query("UPDATE User u SET u.postCount = (SELECT COUNT(p) FROM Post p WHERE p.author = u) WHERE u.id = :userId")
    int updatePostCount(@Param("userId") Long userId);
}

// ê²Œì‹œê¸€ ë¦¬í¬ì§€í† ë¦¬
package com.example.demo.repository;

import com.example.demo.entity.Post;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

public interface PostRepository extends JpaRepository<Post, Long> {
    
    // ì œëª©ìœ¼ë¡œ ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
    Page<Post> findByTitleContainingIgnoreCase(String title, Pageable pageable);
    
    // íŠ¹ì • ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ ì¡°íšŒ (í˜ì´ì§• ì²˜ë¦¬)
    Page<Post> findByAuthorId(Long authorId, Pageable pageable);
    
    // ì œëª© ë˜ëŠ” ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰ (JPQL)
    @Query("SELECT p FROM Post p WHERE LOWER(p.title) LIKE LOWER(CONCAT('%', :keyword, '%')) " +
           "OR LOWER(p.content) LIKE LOWER(CONCAT('%', :keyword, '%'))")
    Page<Post> search(@Param("keyword") String keyword, Pageable pageable);
    
    // íŠ¹ì • íƒœê·¸ê°€ í¬í•¨ëœ ê²Œì‹œê¸€ ì¡°íšŒ
    @Query("SELECT p FROM Post p JOIN p.tags t WHERE t.name = :tagName")
    Page<Post> findByTagName(@Param("tagName") String tagName, Pageable pageable);
    
    // ì¸ê¸° ê²Œì‹œê¸€ ì¡°íšŒ (ëŒ“ê¸€ ìˆ˜ ê¸°ì¤€)
    @Query("SELECT p FROM Post p LEFT JOIN p.comments c GROUP BY p.id ORDER BY COUNT(c) DESC")
    Page<Post> findPopularPosts(Pageable pageable);
    
    // í†µê³„ ì¡°íšŒ (ì˜ˆ: ì›”ë³„ ê²Œì‹œê¸€ ìˆ˜)
    @Query(value = 
        "SELECT TO_CHAR(created_at, 'YYYY-MM') AS month, COUNT(*) AS count " +
        "FROM posts GROUP BY TO_CHAR(created_at, 'YYYY-MM') ORDER BY month",
        nativeQuery = true)
    List<Object[]> countPostsByMonth();
    
    // íŠ¹ì • ê¸°ê°„ ë™ì•ˆì˜ ì¼ë³„ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ
    @Query("SELECT DATE(p.createdAt) as date, COUNT(p) as count FROM Post p " +
           "WHERE p.createdAt BETWEEN :startDate AND :endDate " +
           "GROUP BY DATE(p.createdAt) ORDER BY date")
    List<Object[]> countPostsByDate(
        @Param("startDate") LocalDateTime startDate,
        @Param("endDate") LocalDateTime endDate
    );
    
    // ê²Œì‹œê¸€ê³¼ ì‘ì„±ì ì •ë³´ë¥¼ í•¨ê»˜ ì¡°íšŒ (í˜ì¹˜ ì¡°ì¸)
    @Query("SELECT p FROM Post p JOIN FETCH p.author WHERE p.id = :id")
    Optional<Post> findByIdWithAuthor(@Param("id") Long id);
    
    // ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ ëª©ë¡ì„ í•¨ê»˜ ì¡°íšŒ (ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ + í˜ì´ì§•)
    @Query(value = "SELECT p FROM Post p LEFT JOIN FETCH p.comments WHERE p.author.id = :authorId",
           countQuery = "SELECT COUNT(p) FROM Post p WHERE p.author.id = :authorId")
    Page<Post> findByAuthorIdWithComments(@Param("authorId") Long authorId, Pageable pageable);
    
    // ë²Œí¬ ì—…ë°ì´íŠ¸: íŠ¹ì • ì‚¬ìš©ìì˜ ëª¨ë“  ê²Œì‹œê¸€ ë¹„í™œì„±í™”
    @Modifying
    @Query("UPDATE Post p SET p.status = 'INACTIVE' WHERE p.author.id = :authorId")
    int deactivatePostsByAuthorId(@Param("authorId") Long authorId);
}</code></pre>
          
          <div class="tip">
            <h4>ğŸ’¡ Spring Data JPA ì¿¼ë¦¬ ë©”ì„œë“œ í‚¤ì›Œë“œ</h4>
            <ul>
              <li><code>find...By</code>, <code>read...By</code>, <code>query...By</code>, <code>count...By</code>, <code>exists...By</code>: ì¿¼ë¦¬ ë©”ì„œë“œ ì ‘ë‘ì‚¬</li>
              <li><code>And</code>, <code>Or</code>: ì¡°ê±´ ê²°í•©</li>
              <li><code>Is</code>, <code>Equals</code>: ì¼ì¹˜ ê²€ìƒ‰ (=)</li>
              <li><code>LessThan</code>, <code>LessThanEqual</code>, <code>GreaterThan</code>, <code>GreaterThanEqual</code>: ë¹„êµ ì—°ì‚°</li>
              <li><code>Between</code>: ë²”ìœ„ ê²€ìƒ‰</li>
              <li><code>IsNull</code>, <code>IsNotNull</code>: NULL ê²€ì‚¬</li>
              <li><code>Like</code>, <code>NotLike</code>: íŒ¨í„´ ë§¤ì¹­</li>
              <li><code>StartingWith</code>, <code>EndingWith</code>, <code>Containing</code>: ë¬¸ìì—´ í¬í•¨ ì—¬ë¶€</li>
              <li><code>OrderBy</code>: ì •ë ¬</li>
              <li><code>IgnoreCase</code>: ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰</li>
            </ul>
          </div>
        </div>

        <div class="step">
          <h3><span class="step-number">2</span> ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„</h3>
          <p>ë³µì¡í•œ ì¿¼ë¦¬ë‚˜ íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ëŠ” ë¡œì§ì€ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          
          <pre class="code-block"><code class="language-java">// 1. ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤
package com.example.demo.repository;

import com.example.demo.entity.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

import java.util.List;

public interface UserRepositoryCustom {
    
    // ì‚¬ìš©ìì™€ ê·¸ë“¤ì˜ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ
    List<Object[]> findUsersWithPostCount();
    
    // ê²€ìƒ‰ ì¡°ê±´ì— ë”°ë¥¸ ë™ì  ì¿¼ë¦¬
    Page<User> searchUsers(String keyword, User.UserStatus status, Pageable pageable);
    
    // ë²Œí¬ ì—…ë°ì´íŠ¸: ë¹„í™œì„± ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ ì¼ê´„ ì‚­ì œ
    int deleteInactiveUsersPosts();
    
    // ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•œ ë³µì¡í•œ í†µê³„ ì¡°íšŒ
    List<Object[]> getUserStatsByMonth(int year);
}

// 2. ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„ì²´
package com.example.demo.repository.impl;

import com.example.demo.entity.User;
import com.example.demo.repository.UserRepositoryCustom;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.util.StringUtils;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.*;
import java.util.List;

@Repository
@RequiredArgsConstructor
public class UserRepositoryImpl implements UserRepositoryCustom {
    
    @PersistenceContext
    private final EntityManager em;
    
    private final JdbcTemplate jdbcTemplate;
    
    @Override
    public List<Object[]> findUsersWithPostCount() {
        String jpql = """
            SELECT u, COUNT(p) 
            FROM User u 
            LEFT JOIN u.posts p 
            GROUP BY u
            """;
        return em.createQuery(jpql, Object[].class).getResultList();
    }
    
    @Override
    public Page<User> searchUsers(String keyword, User.UserStatus status, Pageable pageable) {
        // Criteria APIë¥¼ ì‚¬ìš©í•œ ë™ì  ì¿¼ë¦¬ êµ¬ì„±
        CriteriaBuilder cb = em.getCriteriaBuilder();
        CriteriaQuery<User> cq = cb.createQuery(User.class);
        Root<User> user = cq.from(User.class);
        
        // ë™ì  ì¡°ê±´ êµ¬ì„±
        Predicate predicate = cb.conjunction();
        
        if (StringUtils.hasText(keyword)) {
            Predicate keywordPredicate = cb.or(
                cb.like(user.get("username"), "%" + keyword + "%"),
                cb.like(user.get("email"), "%" + keyword + "%")
            );
            predicate = cb.and(predicate, keywordPredicate);
        }
        
        if (status != null) {
            predicate = cb.and(predicate, cb.equal(user.get("status"), status));
        }
        
        cq.where(predicate);
        
        // ì •ë ¬ ì ìš©
        if (pageable.getSort().isSorted()) {
            pageable.getSort().stream()
                .forEach(order -> {
                    if (order.isAscending()) {
                        cq.orderBy(cb.asc(user.get(order.getProperty())));
                    } else {
                        cq.orderBy(cb.desc(user.get(order.getProperty())));
                    }
                });
        }
        
        // í˜ì´ì§• ì ìš©
        TypedQuery<User> query = em.createQuery(cq);
        query.setFirstResult((int) pageable.getOffset());
        query.setMaxResults(pageable.getPageSize());
        
        // ì´ ê°œìˆ˜ ì¡°íšŒë¥¼ ìœ„í•œ ì¿¼ë¦¬
        CriteriaQuery<Long> countQuery = cb.createQuery(Long.class);
        Root<User> countRoot = countQuery.from(User.class);
        countQuery.select(cb.count(countRoot)).where(predicate);
        
        Long total = em.createQuery(countQuery).getSingleResult();
        
        return new PageImpl<>(query.getResultList(), pageable, total);
    }
    
    @Override
    public int deleteInactiveUsersPosts() {
        String jpql = """
            DELETE FROM Post p 
            WHERE p.author IN (
                SELECT u FROM User u 
                WHERE u.status = 'INACTIVE' AND u.updatedAt < CURRENT_DATE - 30
            )
            """;
            
        return em.createQuery(jpql).executeUpdate();
    }
    
    @Override
    public List<Object[]> getUserStatsByMonth(int year) {
        String sql = """
            SELECT 
                EXTRACT(MONTH FROM created_at) AS month,
                COUNT(*) AS total_users,
                SUM(CASE WHEN status = 'ACTIVE' THEN 1 ELSE 0 END) AS active_users,
                SUM(CASE WHEN status = 'INACTIVE' THEN 1 ELSE 0 END) AS inactive_users
            FROM users
            WHERE EXTRACT(YEAR FROM created_at) = :year
            GROUP BY EXTRACT(MONTH FROM created_at)
            ORDER BY month
            """;
            
        return jdbcTemplate.queryForList(sql)
            .stream()
            .map(row -> new Object[]{
                row.get("month"),
                row.get("total_users"),
                row.get("active_users"),
                row.get("inactive_users")
            })
            .collect(Collectors.toList());
    }
}

// 3. ê¸°ì¡´ ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ìƒì†
public interface UserRepository extends JpaRepository<User, Long>, UserRepositoryCustom {
    // ê¸°ì¡´ ë©”ì„œë“œë“¤...
}</code></pre>
        </div>
      </div>

      <div class="section">
        <h2>6. JPA Auditing</h2>
        
        <div class="step">
          <h3><span class="step-number">1</span> JPA Auditing ì„¤ì •</h3>
          <p>ì—”í‹°í‹°ì˜ ìƒì„±ì¼ì‹œ, ìˆ˜ì •ì¼ì‹œ, ìƒì„±ì, ìˆ˜ì •ì ë“±ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          
          <pre class="code-block"><code class="language-java">// 1. ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ì— @EnableJpaAuditing ì¶”ê°€
@SpringBootApplication
@EnableJpaAuditing(auditorAwareRef = "auditorProvider")
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
    
    @Bean
    public AuditorAware<String> auditorProvider() {
        // Spring Securityì™€ ì—°ë™í•˜ì—¬ í˜„ì¬ ì‚¬ìš©ì ID ë°˜í™˜
        return () -> Optional.ofNullable(SecurityContextHolder.getContext())
            .map(SecurityContext::getAuthentication)
            .filter(Authentication::isAuthenticated)
            .map(Authentication::getName)
            .or(() -> Optional.of("system"));
    }
}

// 2. Auditingì„ ìœ„í•œ ë² ì´ìŠ¤ ì—”í‹°í‹°
@MappedSuperclass
@Getter
@EntityListeners(AuditingEntityListener.class)
public abstract class BaseEntity {
    
    @CreatedDate
    @Column(name = "created_at", updatable = false)
    private LocalDateTime createdAt;
    
    @LastModifiedDate
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @CreatedBy
    @Column(name = "created_by", updatable = false)
    private String createdBy;
    
    @LastModifiedBy
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Version
    @Column(name = "version")
    private Long version;
}

// 3. ì—”í‹°í‹°ì—ì„œ ìƒì†í•˜ì—¬ ì‚¬ìš©
@Entity
@Table(name = "posts")
@Getter @Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Post extends BaseEntity {
    // ë‚˜ë¨¸ì§€ í•„ë“œ ë° ë©”ì„œë“œ...
}</code></pre>
        </div>
      </div>

      <div class="nav-buttons">
        <a href="spring_boot_database_part3.html" class="nav-button">â† ì´ì „: JPA ì—”í‹°í‹° ë§¤í•‘</a>
        <a href="spring_boot_database_part5.html" class="nav-button">ë‹¤ìŒ: íŠ¸ëœì­ì…˜ ê´€ë¦¬ â†’</a>
      </div>
    </main>
  </div>
</body>
</html>
